<div class="parent">
  <div *ngIf="!contactPersonDetailsView" class="div1">
    <h2 class="m-0 title">{{ title }}</h2>
    <p class="tab-panel-paragraph">
      {{ description }}
    </p>
    <p-button
      *ngIf="addPurchasingOrderFileForm"
      icon="pi pi-cog"
      label="View Purchasing Order File"
      icon="pi pi-cog"
      (click)="viewPurchasingOrderFiles()"
      class="custom-view m-0 float-right"
    />
  </div>
  <div class="div2" [ngClass]="{ span: applyReusable }">
    <form
      [formGroup]="formGroup"
      *ngIf="addPurchasingOrderFileForm"
      (ngSubmit)="onSubmit()"
    >
      <label for="purchaseOrderId"
        >Purchase Order <sup class="danger">*</sup></label
      >
      <p-select
        [filter]="true"
        filterBy="number"
        [showClear]="true"
        id="purchaseOrderId"
        [options]="purchaseOrders"
        [readonly]="true"
        optionLabel="number"
        placeholder="Select Purchase Order"
        formControlName="purchaseOrderId"
        optionValue="id"
        [ngClass]="{
          'ng-invalid':
            formGroup.get('purchaseOrderId')?.invalid &&
            (formGroup.get('purchaseOrderId')?.dirty ||
              formGroup.get('purchaseOrderId')?.touched)
        }"
      ></p-select>

      <small
        class="p-error"
        *ngIf="
          formGroup.get('purchaseOrderId')?.hasError('required') &&
          formGroup.get('purchaseOrderId')?.touched
        "
      >
        Purchase Order is required.
      </small>
      <br />
      <label for="documentTypeId"
        >Document Type <sup class="danger">*</sup></label
      >
      <p-select
        [filter]="true"
        filterBy="name"
        [showClear]="true"
        id="documentTypeId"
        [options]="documentTypes"
        dataKey="id"
        optionLabel="name"
        optionValue="id"
        placeholder="Select Document Type"
        formControlName="documentTypeId"
        [ngClass]="{
          'ng-invalid':
            formGroup.get('documentTypeId')?.invalid &&
            (formGroup.get('documentTypeId')?.dirty ||
              formGroup.get('documentTypeId')?.touched)
        }"
      ></p-select>

      <small
        class="p-error"
        *ngIf="
          formGroup.get('documentTypeId')?.hasError('required') &&
          formGroup.get('documentTypeId')?.touched
        "
      >
        Document Type is required.
      </small>
      <br />
      <label for="expiryDate">Expiry Date <sup class="danger">*</sup></label>
      <shared-date-picker formControlName="expiryDate" inputId="date">
      </shared-date-picker>
      <div class="my-5" [ngClass]="{ 'edit-mode': editMode }">
        <div *ngIf="(editMode || viewOnly) && existingFileName" class="mb-2">
          <i class="pi pi-paperclip mr-2"></i>

          <a
            *ngIf="existingFileSafeUrl; else justName"
            [href]="existingFileSafeUrl"
            target="_blank"
            rel="noopener"
            (click)="onFileLinkClick($event)"
          >
            {{ existingFileName }}
          </a>
          <br /><br />
          <button
            type="button"
            pButton
            label="Copy Path"
            class="p-button-text py-3 px-4 ml-2"
            (click)="copyPath()"
          ></button>

          <ng-template #justName>{{ existingFileName }}</ng-template>
        </div>

        <!-- You already have this somewhere in the page -->
        <p-toast></p-toast>

        <p-fileupload
          *ngIf="!editMode && !viewOnly"
          #fileUploader
          name="files[]"
          [multiple]="true"
          [showUploadButton]="false"
          (onSelect)="onSelect($event)"
          maxFileSize="1000000"
          mode="basic"
          [auto]="false"
          [customUpload]="true"
          [previewWidth]="100"
          styleClass="w-full"
        >
          <ng-template #empty>
            <div>Drag and drop files to here to upload.</div>
          </ng-template> </p-fileupload
        ><!-- Custom preview list -->
        <div class="mt-3 grid grid-nogutter gap-3">
          <div *ngFor="let p of previews" class="p-2 border-round surface-100">
            <div class="font-medium mb-2">{{ p.name }}</div>

            <!-- Images -->
            <img
              *ngIf="p.type.startsWith('image/')"
              [src]="p.url"
              alt="{{ p.name }}"
              style="max-width: 320px; max-height: 240px; display: block"
            />

            <!-- PDFs -->
            <iframe
              *ngIf="p.type === 'application/pdf'"
              [src]="p.safeUrl"
              style="width: 100%; height: 420px; border: none"
            ></iframe>

            <!-- Fallback for other types -->
            <div
              *ngIf="
                !p.type.startsWith('image/') && p.type !== 'application/pdf'
              "
            >
              <i class="pi pi-file mr-2"></i> No inline preview available.
              <a [href]="p.url" download>Download</a>
            </div>

            <button
              pButton
              type="button"
              label="Remove"
              class="p-button-text mt-2"
              (click)="removePreview(p)"
            ></button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>
